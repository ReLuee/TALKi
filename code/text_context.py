import logging
from typing import Optional, Set, Tuple, Dict, Union # íƒ€ì… íŒíŠ¸ë¥¼ ìœ„í•´ ì¶”ê°€

logger = logging.getLogger(__name__)
from colors import Colors # ì™¸ë¶€ì—ì„œ í•„ìš”í•˜ë‹¤ê³  ê°€ì •

class TextContext:
    """
    ì£¼ì–´ì§„ ë¬¸ìì—´ì—ì„œ ì˜ë¯¸ ìˆëŠ” í…ìŠ¤íŠ¸ ì„¸ê·¸ë¨¼íŠ¸(ì»¨í…ìŠ¤íŠ¸)ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.

    ì´ í´ë˜ìŠ¤ëŠ” ë¯¸ë¦¬ ì •ì˜ëœ ë¶„ë¦¬ í† í°ìœ¼ë¡œ ëë‚˜ê³ , ì§€ì •ëœ ê¸¸ì´ ì œì•½ ì¡°ê±´ì„ ì¤€ìˆ˜í•˜ë©°,
    ìµœì†Œí•œì˜ ì˜ìˆ«ì ë¬¸ìë¥¼ í¬í•¨í•˜ëŠ” ë¶€ë¶„ ë¬¸ìì—´ì„ ì‹ë³„í•©ë‹ˆë‹¤.
    """
    def __init__(self, split_tokens: Optional[Set[str]] = None) -> None:
        """
        TextContext í”„ë¡œì„¸ì„œë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.

        ìœ íš¨í•œ ì»¨í…ìŠ¤íŠ¸ ê²½ê³„ë¥¼ ê²°ì •í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ë¬¸ìë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

        Args:
            split_tokens: ì„ íƒì ì¸ ë¬¸ìì—´ ì§‘í•©. ê° ë¬¸ìì—´ì€ ì ì¬ì ì¸
                          ì»¨í…ìŠ¤íŠ¸ ë ë§ˆì»¤ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤. Noneì¸ ê²½ìš°, ê¸°ë³¸
                          êµ¬ë‘ì  ë° ê³µë°± ë¬¸ì ì§‘í•©ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.
        """
        if split_tokens is None:
            # ëª…í™•ì„±ì„ ìœ„í•´ ë‚´ë¶€ì ìœ¼ë¡œ ë” ëª…ì‹œì ì¸ ë³€ìˆ˜ ì´ë¦„ ì‚¬ìš©
            default_splits: Set[str] = {".", "!", "?", ",", ";", ":", "\n", "-", "ã€‚", "ã€"}
            self.split_tokens: Set[str] = default_splits
        else:
            self.split_tokens: Set[str] = set(split_tokens)

    def get_context(self, txt: str, min_len: int = 6, max_len: int = 120, min_alnum_count: int = 10) -> Tuple[Optional[str], Optional[str]]:
        """
        ì…ë ¥ í…ìŠ¤íŠ¸ì˜ ì‹œì‘ ë¶€ë¶„ì—ì„œ ê°€ì¥ ì§§ì€ ìœ íš¨í•œ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì°¾ìŠµë‹ˆë‹¤.

        `txt` í…ìŠ¤íŠ¸ë¥¼ ì‹œì‘ë¶€í„° `max_len` ë¬¸ìê¹Œì§€ ìŠ¤ìº”í•©ë‹ˆë‹¤. `self.split_tokens`ì˜
        ë¬¸ìê°€ ì²˜ìŒ ë‚˜íƒ€ë‚˜ëŠ” ìœ„ì¹˜ë¥¼ ì°¾ìŠµë‹ˆë‹¤. ë°œê²¬ë˜ë©´, í•´ë‹¹ í† í°ì—ì„œ ëë‚˜ëŠ”
        ë¶€ë¶„ ë¬¸ìì—´ì´ `min_len`(ì „ì²´ ê¸¸ì´) ë° `min_alnum_count`(ì˜ìˆ«ì ë¬¸ì ìˆ˜)
        ê¸°ì¤€ì„ ì¶©ì¡±í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

        Args:
            txt: ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•  ì…ë ¥ ë¬¸ìì—´.
            min_len: ì¶”ì¶œëœ ì»¨í…ìŠ¤íŠ¸ ë¶€ë¶„ ë¬¸ìì—´ì— í—ˆìš©ë˜ëŠ” ìµœì†Œ ì „ì²´ ê¸¸ì´.
            max_len: ì¶”ì¶œëœ ì»¨í…ìŠ¤íŠ¸ ë¶€ë¶„ ë¬¸ìì—´ì— í—ˆìš©ë˜ëŠ” ìµœëŒ€ ì „ì²´ ê¸¸ì´.
                     ì´ ë¬¸ì ìˆ˜ë¥¼ ê²€ì‚¬í•œ í›„ ê²€ìƒ‰ì´ ì¤‘ì§€ë©ë‹ˆë‹¤.
            min_alnum_count: ì¶”ì¶œëœ ì»¨í…ìŠ¤íŠ¸ ë¶€ë¶„ ë¬¸ìì—´ ë‚´ì— í•„ìš”í•œ ìµœì†Œ
                             ì˜ìˆ«ì ë¬¸ì ìˆ˜.

        Returns:
            ë‹¤ìŒì„ í¬í•¨í•˜ëŠ” íŠœí”Œ:
            - ë°œê²¬ëœ ê²½ìš° ì¶”ì¶œëœ ì»¨í…ìŠ¤íŠ¸ ë¬¸ìì—´, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ None.
            - ì»¨í…ìŠ¤íŠ¸ ì´í›„ì˜ ì…ë ¥ ë¬¸ìì—´ì˜ ë‚˜ë¨¸ì§€ ë¶€ë¶„, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ None.
            ì œì•½ ì¡°ê±´ ë‚´ì—ì„œ ì í•©í•œ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì°¾ì§€ ëª»í•˜ë©´ (None, None)ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
        """
        alnum_count = 0

        for i in range(1, min(len(txt), max_len) + 1):
            char = txt[i - 1]
            if char.isalnum():
                alnum_count += 1

            # í˜„ì¬ ë¬¸ìê°€ ì ì¬ì ì¸ ì»¨í…ìŠ¤íŠ¸ ëì¸ì§€ í™•ì¸
            if char in self.split_tokens:
                # ê¸¸ì´ ë° ì˜ìˆ«ì ìˆ˜ ê¸°ì¤€ì´ ì¶©ì¡±ë˜ëŠ”ì§€ í™•ì¸
                if i >= min_len and alnum_count >= min_alnum_count:
                    context_str = txt[:i]
                    remaining_str = txt[i:]
                    logger.info(f"ğŸ§  {Colors.MAGENTA}ë¬¸ì ë²ˆí˜¸ {i} ë’¤ì—ì„œ ì»¨í…ìŠ¤íŠ¸ ë°œê²¬, ì»¨í…ìŠ¤íŠ¸: {context_str}")
                    return context_str, remaining_str

        # max_len ì œí•œ ë‚´ì—ì„œ ì í•©í•œ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì°¾ì§€ ëª»í•¨
        return None, None
